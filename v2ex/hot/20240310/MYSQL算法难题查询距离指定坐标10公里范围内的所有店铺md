### *** MYSQL 算法难题: 查询距离指定坐标 10 公里范围内的所有店铺 ***

我有 MYSQL 表含 20 万条记录,  每条记录有店铺和位置经纬度字段.  现在我用 sql 查询距离指定坐标半径 10 公里内的所有店铺, 发现查询速度奇慢, 做了 index 后也是如此.  

问题:
1. 上述需求,用啥数据格式的字段存位置经纬度合适?
2. 求最新最快的半径 10 公里内的所有店铺查询算法, 最好支持 MYSQL.

谢谢

---------------------------------------------------

where 条件限制经纬度差距各+-0.1 度,然后再算

---------------------------------------------------

先把店铺按照城市区域分好区

---------------------------------------------------

建一个大一些的基础网格系统，正方形，三角形，六边形，提前划分标记一下这些经纬度

---------------------------------------------------

你先说下 你怎么计算距离的呢

---------------------------------------------------

https://i.imgur.com/9rRSEpz.png

---------------------------------------------------

https://redis.io/docs/data-types/geospatial/

我第一次见坐标用 MySQL 实现的。。。你不得算距离啊

---------------------------------------------------

mysql 也有 geo 功能，自己看看文档呗

---------------------------------------------------

这个需求是不是可以用空间数据类型来存啊

---------------------------------------------------

https://www.mysqlzh.com/doc/176/143.html

---------------------------------------------------

@xmumiffy 经度有错误,还要除余弦

---------------------------------------------------

@dode 六边形感觉是个有意思的思路，像文明 6 那样数格子就行了

---------------------------------------------------

Redis geo 或者 PostGIS

---------------------------------------------------

思路错了。这就好比，你选择用汇编去实现，然后发个新帖子：汇编算法难题。

正确的思路是，选择支持地理范围直接查询的数据库，用它做个冗余数据库，专门做地理查询服务就行了，不要为难 MySQL ，很多场景，Mysql 并不适合。

---------------------------------------------------

redis

---------------------------------------------------

XY 问题，你还是使用 GEO 存储吧

---------------------------------------------------

之前做过地理位置相关的，经纬度小数点第一位精度是 10 公里左右，数据库按一位小数存经纬度，查询 sql 就变成等值查询了

---------------------------------------------------

我在想如果用 postgresql 会不会更好写。

---------------------------------------------------

@546L5LiK6ZOt 这也太糊弄了，0.9 和 1.1 匹配吗？

---------------------------------------------------

根据坐标和 10 公里的条件，确定极限范围：
A <= 经度 <= B
C <= 纬度 <= D
然后在查到的数据中，使用子查询验证是否真正满足 10 公里的条件。
这样可以避免全表计算距离。

---------------------------------------------------

mysql 自带空间数据类型 geometry + 空间索引，可以自己研究一下 mysql 文档，查询就直接构造出一个圆面（用合适边数的多边形去近似即可），查出和这个圆面相交坐标点就 ojbk 了，基本上所有数据库通用

---------------------------------------------------

指定中心点坐标、半径，生成圆面的代码，可以参考我的 AreaCity-Query-Geometry 代码，30 行

https://github.com/xiangyuecn/AreaCity-Query-Geometry/blob/b626c53a85350c43c64e7886e926c3e9ac877a52/AreaCityQuery.java#L1375-L1402

其中采用 Haversine formula 算法 计算经纬度坐标的距离，5 行代码

---------------------------------------------------

没记错的话 redis 好像有这个功能，

---------------------------------------------------

@546L5LiK6ZOt 实际上每经度距离和纬度相关，这样算这个库在北京就用不了了。

---------------------------------------------------

以前流行过 geohash ，如果 MySQL 自己的地理信息功能挑不起来大梁，可以尝试附加一个 geohash

---------------------------------------------------

另外如果可行，还是推荐使用现成可靠的地理信息设施，比如 PostGIS ，应该比 MySQL 自己的 GIS 功能强得多

---------------------------------------------------

不要折腾，全部加载出来，一个工具类的事

---------------------------------------------------

用过 postgis

---------------------------------------------------

楼上一群半吊子，这个是计算量的问题，需要消耗 cpu 资源的，不是换个工具换个数据库就能解决

我司需求是 600 万数据查询经纬度大于 50 米，解决方案是用 spark 并行计算，20 个 task ，一个任务配置 2G 内存

后端大概 50 台刀片机服务器集群，跑一次要 16 个小时

---------------------------------------------------

非要 mysql 吗 geohash 支持那么差劲的
一般用 ES 一步到位或者 Redis 得 geohash 取出 ID 后 mget 获取详情

---------------------------------------------------

@249239432 哈哈 笑死我了才 20w 条记录... 还需要购买额外的资源... 还说别人是半吊子..
说句不客气的话..200w 数据 postgis 也是轻轻松松搞定...
楼上那么多人提到了 geo 相关的服务..你这也不反思下自己... 果然你是最独特的...

希望你的下一条回复是 "经过认真分析,确实 geo 工具有可行性"

---------------------------------------------------

@249239432 我也是搞大数据的，你这个 spark 的方案是真的有问题。spark 也有空间计算库 GeoSpark...。不需要硬算了。不论什么需求，一个 Job16 个小时真的吓到了。 再说了，人家 OP 是要实时查询的方法，很明显用楼上的 redis/mysql geo 数据类型可以解决。

---------------------------------------------------

这个不知道 我司用的是 pg pg 有自带的函数 ST_within 这个函数 能实现你说的功能

---------------------------------------------------

你们就不知道好好审题？，一个心眼钻牛角尖用什么工具、框架、软件上？
集群计算速度快还是用你那台数据库或者 postgis 计算快?

@yingqi1 我用程序硬算都能算出来，纠结这东西干什么，不用集群能变快么？

@changdy 我说的是我司方案，你意淫到别人头上去了？

---------------------------------------------------

@changdy 200w 数据轻松搞定，5 个小时搞定？

---------------------------------------------------

有个很简单很取巧的做法：

经度和纬度分两个字段，并仅对纬度建立索引。由于纬度等距，相差 0.09 度大约为 10 公里，且中国大城市纬度分布差异较大，这样能利用索引初步筛选，把 20 万筛选到 5000 以内。然后再用距离公式精确计算。

---------------------------------------------------

1.mysql 8.x 已经支持了，直接 sql 能实现，加上空间索引搜索非常快

2. redis geo 除了 mysql 之外最快的方案

3. 以上两种方案仅限于单纯的范围检索，如果是社交类的场景比如 5 公里范围内的排序外加+女的+18 的+3 天内上线过的+兴趣爱好 in (a,b,c)  的。那就老老实实上 elasticsearch 类的搜索引擎，没有任何其他方法可以最低成本实现。

---------------------------------------------------

@249239432 典型的数据结构问题，关集群什么事情。  审题: 20 万行数据，产品 ID (int)、经纬度(geohash) 各 8 字节。撑死 10 多 M ，要个鸡毛集群。 再说说 spark 不是框架/软件吗？ 好好学习，请不要再使用“一群半吊子”的词汇了。

---------------------------------------------------

@yingqi1 这是计算量的问题，跟数据大小有什么关系，说不过就开始专牛角尖了？ spark 我还不知道是什么东西么

2. 求最新最快的半径 10 公里内的所有店铺查询算法, 最好支持 MYSQL.
你这叫审题？  我用集群是不是比你用单机快？

---------------------------------------------------

指定中心点坐标、半径，生成圆面的代码，可以参考我的 AreaCity-Query-Geometry 代码，30 行

https://github.com/xiangyuecn/AreaCity-Query-Geometry/blob/b626c53a85350c43c64e7886e926c3e9ac877a52/AreaCityQuery.java#L1375-L1402

其中采用 Haversine formula 算法 计算经纬度坐标的距离，5 行代码

---------------------------------------------------

没记错的话 redis 好像有这个功能，

---------------------------------------------------

@546L5LiK6ZOt 实际上每经度距离和纬度相关，这样算这个库在北京就用不了了。

---------------------------------------------------

以前流行过 geohash ，如果 MySQL 自己的地理信息功能挑不起来大梁，可以尝试附加一个 geohash

---------------------------------------------------

另外如果可行，还是推荐使用现成可靠的地理信息设施，比如 PostGIS ，应该比 MySQL 自己的 GIS 功能强得多

---------------------------------------------------

不要折腾，全部加载出来，一个工具类的事

---------------------------------------------------

用过 postgis

---------------------------------------------------

楼上一群半吊子，这个是计算量的问题，需要消耗 cpu 资源的，不是换个工具换个数据库就能解决

我司需求是 600 万数据查询经纬度大于 50 米，解决方案是用 spark 并行计算，20 个 task ，一个任务配置 2G 内存

后端大概 50 台刀片机服务器集群，跑一次要 16 个小时

---------------------------------------------------

非要 mysql 吗 geohash 支持那么差劲的
一般用 ES 一步到位或者 Redis 得 geohash 取出 ID 后 mget 获取详情

---------------------------------------------------

@249239432 哈哈 笑死我了才 20w 条记录... 还需要购买额外的资源... 还说别人是半吊子..
说句不客气的话..200w 数据 postgis 也是轻轻松松搞定...
楼上那么多人提到了 geo 相关的服务..你这也不反思下自己... 果然你是最独特的...

希望你的下一条回复是 "经过认真分析,确实 geo 工具有可行性"

---------------------------------------------------

@249239432 我也是搞大数据的，你这个 spark 的方案是真的有问题。spark 也有空间计算库 GeoSpark...。不需要硬算了。不论什么需求，一个 Job16 个小时真的吓到了。 再说了，人家 OP 是要实时查询的方法，很明显用楼上的 redis/mysql geo 数据类型可以解决。

---------------------------------------------------

这个不知道 我司用的是 pg pg 有自带的函数 ST_within 这个函数 能实现你说的功能

---------------------------------------------------

你们就不知道好好审题？，一个心眼钻牛角尖用什么工具、框架、软件上？
集群计算速度快还是用你那台数据库或者 postgis 计算快?

@yingqi1 我用程序硬算都能算出来，纠结这东西干什么，不用集群能变快么？

@changdy 我说的是我司方案，你意淫到别人头上去了？

---------------------------------------------------

@changdy 200w 数据轻松搞定，5 个小时搞定？

---------------------------------------------------

有个很简单很取巧的做法：

经度和纬度分两个字段，并仅对纬度建立索引。由于纬度等距，相差 0.09 度大约为 10 公里，且中国大城市纬度分布差异较大，这样能利用索引初步筛选，把 20 万筛选到 5000 以内。然后再用距离公式精确计算。

---------------------------------------------------

1.mysql 8.x 已经支持了，直接 sql 能实现，加上空间索引搜索非常快

2. redis geo 除了 mysql 之外最快的方案

3. 以上两种方案仅限于单纯的范围检索，如果是社交类的场景比如 5 公里范围内的排序外加+女的+18 的+3 天内上线过的+兴趣爱好 in (a,b,c)  的。那就老老实实上 elasticsearch 类的搜索引擎，没有任何其他方法可以最低成本实现。

---------------------------------------------------

@249239432 典型的数据结构问题，关集群什么事情。  审题: 20 万行数据，产品 ID (int)、经纬度(geohash) 各 8 字节。撑死 10 多 M ，要个鸡毛集群。 再说说 spark 不是框架/软件吗？ 好好学习，请不要再使用“一群半吊子”的词汇了。

---------------------------------------------------

@yingqi1 这是计算量的问题，跟数据大小有什么关系，说不过就开始专牛角尖了？ spark 我还不知道是什么东西么

2. 求最新最快的半径 10 公里内的所有店铺查询算法, 最好支持 MYSQL.
你这叫审题？  我用集群是不是比你用单机快？

---------------------------------------------------

指定中心点坐标、半径，生成圆面的代码，可以参考我的 AreaCity-Query-Geometry 代码，30 行

https://github.com/xiangyuecn/AreaCity-Query-Geometry/blob/b626c53a85350c43c64e7886e926c3e9ac877a52/AreaCityQuery.java#L1375-L1402

其中采用 Haversine formula 算法 计算经纬度坐标的距离，5 行代码

---------------------------------------------------

没记错的话 redis 好像有这个功能，

---------------------------------------------------

@546L5LiK6ZOt 实际上每经度距离和纬度相关，这样算这个库在北京就用不了了。

---------------------------------------------------

以前流行过 geohash ，如果 MySQL 自己的地理信息功能挑不起来大梁，可以尝试附加一个 geohash

---------------------------------------------------

另外如果可行，还是推荐使用现成可靠的地理信息设施，比如 PostGIS ，应该比 MySQL 自己的 GIS 功能强得多

---------------------------------------------------

不要折腾，全部加载出来，一个工具类的事

---------------------------------------------------

用过 postgis

---------------------------------------------------

楼上一群半吊子，这个是计算量的问题，需要消耗 cpu 资源的，不是换个工具换个数据库就能解决

我司需求是 600 万数据查询经纬度大于 50 米，解决方案是用 spark 并行计算，20 个 task ，一个任务配置 2G 内存

后端大概 50 台刀片机服务器集群，跑一次要 16 个小时

---------------------------------------------------

非要 mysql 吗 geohash 支持那么差劲的
一般用 ES 一步到位或者 Redis 得 geohash 取出 ID 后 mget 获取详情

---------------------------------------------------

@249239432 哈哈 笑死我了才 20w 条记录... 还需要购买额外的资源... 还说别人是半吊子..
说句不客气的话..200w 数据 postgis 也是轻轻松松搞定...
楼上那么多人提到了 geo 相关的服务..你这也不反思下自己... 果然你是最独特的...

希望你的下一条回复是 "经过认真分析,确实 geo 工具有可行性"

---------------------------------------------------

@249239432 我也是搞大数据的，你这个 spark 的方案是真的有问题。spark 也有空间计算库 GeoSpark...。不需要硬算了。不论什么需求，一个 Job16 个小时真的吓到了。 再说了，人家 OP 是要实时查询的方法，很明显用楼上的 redis/mysql geo 数据类型可以解决。

---------------------------------------------------

这个不知道 我司用的是 pg pg 有自带的函数 ST_within 这个函数 能实现你说的功能

---------------------------------------------------

你们就不知道好好审题？，一个心眼钻牛角尖用什么工具、框架、软件上？
集群计算速度快还是用你那台数据库或者 postgis 计算快?

@yingqi1 我用程序硬算都能算出来，纠结这东西干什么，不用集群能变快么？

@changdy 我说的是我司方案，你意淫到别人头上去了？

---------------------------------------------------

@changdy 200w 数据轻松搞定，5 个小时搞定？

---------------------------------------------------

有个很简单很取巧的做法：

经度和纬度分两个字段，并仅对纬度建立索引。由于纬度等距，相差 0.09 度大约为 10 公里，且中国大城市纬度分布差异较大，这样能利用索引初步筛选，把 20 万筛选到 5000 以内。然后再用距离公式精确计算。

---------------------------------------------------

1.mysql 8.x 已经支持了，直接 sql 能实现，加上空间索引搜索非常快

2. redis geo 除了 mysql 之外最快的方案

3. 以上两种方案仅限于单纯的范围检索，如果是社交类的场景比如 5 公里范围内的排序外加+女的+18 的+3 天内上线过的+兴趣爱好 in (a,b,c)  的。那就老老实实上 elasticsearch 类的搜索引擎，没有任何其他方法可以最低成本实现。

---------------------------------------------------

@249239432 典型的数据结构问题，关集群什么事情。  审题: 20 万行数据，产品 ID (int)、经纬度(geohash) 各 8 字节。撑死 10 多 M ，要个鸡毛集群。 再说说 spark 不是框架/软件吗？ 好好学习，请不要再使用“一群半吊子”的词汇了。

---------------------------------------------------

@yingqi1 这是计算量的问题，跟数据大小有什么关系，说不过就开始专牛角尖了？ spark 我还不知道是什么东西么

2. 求最新最快的半径 10 公里内的所有店铺查询算法, 最好支持 MYSQL.
你这叫审题？  我用集群是不是比你用单机快？

---------------------------------------------------

指定中心点坐标、半径，生成圆面的代码，可以参考我的 AreaCity-Query-Geometry 代码，30 行

https://github.com/xiangyuecn/AreaCity-Query-Geometry/blob/b626c53a85350c43c64e7886e926c3e9ac877a52/AreaCityQuery.java#L1375-L1402

其中采用 Haversine formula 算法 计算经纬度坐标的距离，5 行代码

---------------------------------------------------

没记错的话 redis 好像有这个功能，

---------------------------------------------------

@546L5LiK6ZOt 实际上每经度距离和纬度相关，这样算这个库在北京就用不了了。

---------------------------------------------------

以前流行过 geohash ，如果 MySQL 自己的地理信息功能挑不起来大梁，可以尝试附加一个 geohash

---------------------------------------------------

另外如果可行，还是推荐使用现成可靠的地理信息设施，比如 PostGIS ，应该比 MySQL 自己的 GIS 功能强得多

---------------------------------------------------

不要折腾，全部加载出来，一个工具类的事

---------------------------------------------------

用过 postgis

---------------------------------------------------

楼上一群半吊子，这个是计算量的问题，需要消耗 cpu 资源的，不是换个工具换个数据库就能解决

我司需求是 600 万数据查询经纬度大于 50 米，解决方案是用 spark 并行计算，20 个 task ，一个任务配置 2G 内存

后端大概 50 台刀片机服务器集群，跑一次要 16 个小时

---------------------------------------------------

非要 mysql 吗 geohash 支持那么差劲的
一般用 ES 一步到位或者 Redis 得 geohash 取出 ID 后 mget 获取详情

---------------------------------------------------

@249239432 哈哈 笑死我了才 20w 条记录... 还需要购买额外的资源... 还说别人是半吊子..
说句不客气的话..200w 数据 postgis 也是轻轻松松搞定...
楼上那么多人提到了 geo 相关的服务..你这也不反思下自己... 果然你是最独特的...

希望你的下一条回复是 "经过认真分析,确实 geo 工具有可行性"

---------------------------------------------------

@249239432 我也是搞大数据的，你这个 spark 的方案是真的有问题。spark 也有空间计算库 GeoSpark...。不需要硬算了。不论什么需求，一个 Job16 个小时真的吓到了。 再说了，人家 OP 是要实时查询的方法，很明显用楼上的 redis/mysql geo 数据类型可以解决。

---------------------------------------------------

这个不知道 我司用的是 pg pg 有自带的函数 ST_within 这个函数 能实现你说的功能

---------------------------------------------------

你们就不知道好好审题？，一个心眼钻牛角尖用什么工具、框架、软件上？
集群计算速度快还是用你那台数据库或者 postgis 计算快?

@yingqi1 我用程序硬算都能算出来，纠结这东西干什么，不用集群能变快么？

@changdy 我说的是我司方案，你意淫到别人头上去了？

---------------------------------------------------

@changdy 200w 数据轻松搞定，5 个小时搞定？

---------------------------------------------------

有个很简单很取巧的做法：

经度和纬度分两个字段，并仅对纬度建立索引。由于纬度等距，相差 0.09 度大约为 10 公里，且中国大城市纬度分布差异较大，这样能利用索引初步筛选，把 20 万筛选到 5000 以内。然后再用距离公式精确计算。

---------------------------------------------------

1.mysql 8.x 已经支持了，直接 sql 能实现，加上空间索引搜索非常快

2. redis geo 除了 mysql 之外最快的方案

3. 以上两种方案仅限于单纯的范围检索，如果是社交类的场景比如 5 公里范围内的排序外加+女的+18 的+3 天内上线过的+兴趣爱好 in (a,b,c)  的。那就老老实实上 elasticsearch 类的搜索引擎，没有任何其他方法可以最低成本实现。

---------------------------------------------------

@249239432 典型的数据结构问题，关集群什么事情。  审题: 20 万行数据，产品 ID (int)、经纬度(geohash) 各 8 字节。撑死 10 多 M ，要个鸡毛集群。 再说说 spark 不是框架/软件吗？ 好好学习，请不要再使用“一群半吊子”的词汇了。

---------------------------------------------------

@yingqi1 这是计算量的问题，跟数据大小有什么关系，说不过就开始专牛角尖了？ spark 我还不知道是什么东西么

2. 求最新最快的半径 10 公里内的所有店铺查询算法, 最好支持 MYSQL.
你这叫审题？  我用集群是不是比你用单机快？

---------------------------------------------------

指定中心点坐标、半径，生成圆面的代码，可以参考我的 AreaCity-Query-Geometry 代码，30 行

https://github.com/xiangyuecn/AreaCity-Query-Geometry/blob/b626c53a85350c43c64e7886e926c3e9ac877a52/AreaCityQuery.java#L1375-L1402

其中采用 Haversine formula 算法 计算经纬度坐标的距离，5 行代码

---------------------------------------------------

没记错的话 redis 好像有这个功能，

---------------------------------------------------

@546L5LiK6ZOt 实际上每经度距离和纬度相关，这样算这个库在北京就用不了了。

---------------------------------------------------

以前流行过 geohash ，如果 MySQL 自己的地理信息功能挑不起来大梁，可以尝试附加一个 geohash

---------------------------------------------------

另外如果可行，还是推荐使用现成可靠的地理信息设施，比如 PostGIS ，应该比 MySQL 自己的 GIS 功能强得多

---------------------------------------------------

不要折腾，全部加载出来，一个工具类的事

---------------------------------------------------

用过 postgis

---------------------------------------------------

楼上一群半吊子，这个是计算量的问题，需要消耗 cpu 资源的，不是换个工具换个数据库就能解决

我司需求是 600 万数据查询经纬度大于 50 米，解决方案是用 spark 并行计算，20 个 task ，一个任务配置 2G 内存

后端大概 50 台刀片机服务器集群，跑一次要 16 个小时

---------------------------------------------------

非要 mysql 吗 geohash 支持那么差劲的
一般用 ES 一步到位或者 Redis 得 geohash 取出 ID 后 mget 获取详情

---------------------------------------------------

@249239432 哈哈 笑死我了才 20w 条记录... 还需要购买额外的资源... 还说别人是半吊子..
说句不客气的话..200w 数据 postgis 也是轻轻松松搞定...
楼上那么多人提到了 geo 相关的服务..你这也不反思下自己... 果然你是最独特的...

希望你的下一条回复是 "经过认真分析,确实 geo 工具有可行性"

---------------------------------------------------

@249239432 我也是搞大数据的，你这个 spark 的方案是真的有问题。spark 也有空间计算库 GeoSpark...。不需要硬算了。不论什么需求，一个 Job16 个小时真的吓到了。 再说了，人家 OP 是要实时查询的方法，很明显用楼上的 redis/mysql geo 数据类型可以解决。

---------------------------------------------------

这个不知道 我司用的是 pg pg 有自带的函数 ST_within 这个函数 能实现你说的功能

---------------------------------------------------

你们就不知道好好审题？，一个心眼钻牛角尖用什么工具、框架、软件上？
集群计算速度快还是用你那台数据库或者 postgis 计算快?

@yingqi1 我用程序硬算都能算出来，纠结这东西干什么，不用集群能变快么？

@changdy 我说的是我司方案，你意淫到别人头上去了？

---------------------------------------------------

@changdy 200w 数据轻松搞定，5 个小时搞定？

---------------------------------------------------

有个很简单很取巧的做法：

经度和纬度分两个字段，并仅对纬度建立索引。由于纬度等距，相差 0.09 度大约为 10 公里，且中国大城市纬度分布差异较大，这样能利用索引初步筛选，把 20 万筛选到 5000 以内。然后再用距离公式精确计算。

---------------------------------------------------

1.mysql 8.x 已经支持了，直接 sql 能实现，加上空间索引搜索非常快

2. redis geo 除了 mysql 之外最快的方案

3. 以上两种方案仅限于单纯的范围检索，如果是社交类的场景比如 5 公里范围内的排序外加+女的+18 的+3 天内上线过的+兴趣爱好 in (a,b,c)  的。那就老老实实上 elasticsearch 类的搜索引擎，没有任何其他方法可以最低成本实现。

---------------------------------------------------

@249239432 典型的数据结构问题，关集群什么事情。  审题: 20 万行数据，产品 ID (int)、经纬度(geohash) 各 8 字节。撑死 10 多 M ，要个鸡毛集群。 再说说 spark 不是框架/软件吗？ 好好学习，请不要再使用“一群半吊子”的词汇了。

---------------------------------------------------

@yingqi1 这是计算量的问题，跟数据大小有什么关系，说不过就开始专牛角尖了？ spark 我还不知道是什么东西么

2. 求最新最快的半径 10 公里内的所有店铺查询算法, 最好支持 MYSQL.
你这叫审题？  我用集群是不是比你用单机快？

---------------------------------------------------

指定中心点坐标、半径，生成圆面的代码，可以参考我的 AreaCity-Query-Geometry 代码，30 行

https://github.com/xiangyuecn/AreaCity-Query-Geometry/blob/b626c53a85350c43c64e7886e926c3e9ac877a52/AreaCityQuery.java#L1375-L1402

其中采用 Haversine formula 算法 计算经纬度坐标的距离，5 行代码

---------------------------------------------------

没记错的话 redis 好像有这个功能，

---------------------------------------------------

@546L5LiK6ZOt 实际上每经度距离和纬度相关，这样算这个库在北京就用不了了。

---------------------------------------------------

以前流行过 geohash ，如果 MySQL 自己的地理信息功能挑不起来大梁，可以尝试附加一个 geohash

---------------------------------------------------

另外如果可行，还是推荐使用现成可靠的地理信息设施，比如 PostGIS ，应该比 MySQL 自己的 GIS 功能强得多

---------------------------------------------------

不要折腾，全部加载出来，一个工具类的事

---------------------------------------------------

用过 postgis

---------------------------------------------------

楼上一群半吊子，这个是计算量的问题，需要消耗 cpu 资源的，不是换个工具换个数据库就能解决

我司需求是 600 万数据查询经纬度大于 50 米，解决方案是用 spark 并行计算，20 个 task ，一个任务配置 2G 内存

后端大概 50 台刀片机服务器集群，跑一次要 16 个小时

---------------------------------------------------

非要 mysql 吗 geohash 支持那么差劲的
一般用 ES 一步到位或者 Redis 得 geohash 取出 ID 后 mget 获取详情

---------------------------------------------------

@249239432 哈哈 笑死我了才 20w 条记录... 还需要购买额外的资源... 还说别人是半吊子..
说句不客气的话..200w 数据 postgis 也是轻轻松松搞定...
楼上那么多人提到了 geo 相关的服务..你这也不反思下自己... 果然你是最独特的...

希望你的下一条回复是 "经过认真分析,确实 geo 工具有可行性"

---------------------------------------------------

@249239432 我也是搞大数据的，你这个 spark 的方案是真的有问题。spark 也有空间计算库 GeoSpark...。不需要硬算了。不论什么需求，一个 Job16 个小时真的吓到了。 再说了，人家 OP 是要实时查询的方法，很明显用楼上的 redis/mysql geo 数据类型可以解决。

---------------------------------------------------

这个不知道 我司用的是 pg pg 有自带的函数 ST_within 这个函数 能实现你说的功能

---------------------------------------------------

你们就不知道好好审题？，一个心眼钻牛角尖用什么工具、框架、软件上？
集群计算速度快还是用你那台数据库或者 postgis 计算快?

@yingqi1 我用程序硬算都能算出来，纠结这东西干什么，不用集群能变快么？

@changdy 我说的是我司方案，你意淫到别人头上去了？

---------------------------------------------------

@changdy 200w 数据轻松搞定，5 个小时搞定？

---------------------------------------------------

有个很简单很取巧的做法：

经度和纬度分两个字段，并仅对纬度建立索引。由于纬度等距，相差 0.09 度大约为 10 公里，且中国大城市纬度分布差异较大，这样能利用索引初步筛选，把 20 万筛选到 5000 以内。然后再用距离公式精确计算。

---------------------------------------------------

1.mysql 8.x 已经支持了，直接 sql 能实现，加上空间索引搜索非常快

2. redis geo 除了 mysql 之外最快的方案

3. 以上两种方案仅限于单纯的范围检索，如果是社交类的场景比如 5 公里范围内的排序外加+女的+18 的+3 天内上线过的+兴趣爱好 in (a,b,c)  的。那就老老实实上 elasticsearch 类的搜索引擎，没有任何其他方法可以最低成本实现。

---------------------------------------------------

@249239432 典型的数据结构问题，关集群什么事情。  审题: 20 万行数据，产品 ID (int)、经纬度(geohash) 各 8 字节。撑死 10 多 M ，要个鸡毛集群。 再说说 spark 不是框架/软件吗？ 好好学习，请不要再使用“一群半吊子”的词汇了。

---------------------------------------------------

@yingqi1 这是计算量的问题，跟数据大小有什么关系，说不过就开始专牛角尖了？ spark 我还不知道是什么东西么

2. 求最新最快的半径 10 公里内的所有店铺查询算法, 最好支持 MYSQL.
你这叫审题？  我用集群是不是比你用单机快？

---------------------------------------------------

指定中心点坐标、半径，生成圆面的代码，可以参考我的 AreaCity-Query-Geometry 代码，30 行

https://github.com/xiangyuecn/AreaCity-Query-Geometry/blob/b626c53a85350c43c64e7886e926c3e9ac877a52/AreaCityQuery.java#L1375-L1402

其中采用 Haversine formula 算法 计算经纬度坐标的距离，5 行代码

---------------------------------------------------

没记错的话 redis 好像有这个功能，

---------------------------------------------------

@546L5LiK6ZOt 实际上每经度距离和纬度相关，这样算这个库在北京就用不了了。

---------------------------------------------------

以前流行过 geohash ，如果 MySQL 自己的地理信息功能挑不起来大梁，可以尝试附加一个 geohash

---------------------------------------------------

另外如果可行，还是推荐使用现成可靠的地理信息设施，比如 PostGIS ，应该比 MySQL 自己的 GIS 功能强得多

---------------------------------------------------

不要折腾，全部加载出来，一个工具类的事

---------------------------------------------------

用过 postgis

---------------------------------------------------

楼上一群半吊子，这个是计算量的问题，需要消耗 cpu 资源的，不是换个工具换个数据库就能解决

我司需求是 600 万数据查询经纬度大于 50 米，解决方案是用 spark 并行计算，20 个 task ，一个任务配置 2G 内存

后端大概 50 台刀片机服务器集群，跑一次要 16 个小时

---------------------------------------------------

非要 mysql 吗 geohash 支持那么差劲的
一般用 ES 一步到位或者 Redis 得 geohash 取出 ID 后 mget 获取详情

---------------------------------------------------

@249239432 哈哈 笑死我了才 20w 条记录... 还需要购买额外的资源... 还说别人是半吊子..
说句不客气的话..200w 数据 postgis 也是轻轻松松搞定...
楼上那么多人提到了 geo 相关的服务..你这也不反思下自己... 果然你是最独特的...

希望你的下一条回复是 "经过认真分析,确实 geo 工具有可行性"

---------------------------------------------------

@249239432 我也是搞大数据的，你这个 spark 的方案是真的有问题。spark 也有空间计算库 GeoSpark...。不需要硬算了。不论什么需求，一个 Job16 个小时真的吓到了。 再说了，人家 OP 是要实时查询的方法，很明显用楼上的 redis/mysql geo 数据类型可以解决。

---------------------------------------------------

这个不知道 我司用的是 pg pg 有自带的函数 ST_within 这个函数 能实现你说的功能

---------------------------------------------------

你们就不知道好好审题？，一个心眼钻牛角尖用什么工具、框架、软件上？
集群计算速度快还是用你那台数据库或者 postgis 计算快?

@yingqi1 我用程序硬算都能算出来，纠结这东西干什么，不用集群能变快么？

@changdy 我说的是我司方案，你意淫到别人头上去了？

---------------------------------------------------

@changdy 200w 数据轻松搞定，5 个小时搞定？

---------------------------------------------------

有个很简单很取巧的做法：

经度和纬度分两个字段，并仅对纬度建立索引。由于纬度等距，相差 0.09 度大约为 10 公里，且中国大城市纬度分布差异较大，这样能利用索引初步筛选，把 20 万筛选到 5000 以内。然后再用距离公式精确计算。

---------------------------------------------------

1.mysql 8.x 已经支持了，直接 sql 能实现，加上空间索引搜索非常快

2. redis geo 除了 mysql 之外最快的方案

3. 以上两种方案仅限于单纯的范围检索，如果是社交类的场景比如 5 公里范围内的排序外加+女的+18 的+3 天内上线过的+兴趣爱好 in (a,b,c)  的。那就老老实实上 elasticsearch 类的搜索引擎，没有任何其他方法可以最低成本实现。

---------------------------------------------------

@249239432 典型的数据结构问题，关集群什么事情。  审题: 20 万行数据，产品 ID (int)、经纬度(geohash) 各 8 字节。撑死 10 多 M ，要个鸡毛集群。 再说说 spark 不是框架/软件吗？ 好好学习，请不要再使用“一群半吊子”的词汇了。

---------------------------------------------------

@yingqi1 这是计算量的问题，跟数据大小有什么关系，说不过就开始专牛角尖了？ spark 我还不知道是什么东西么

2. 求最新最快的半径 10 公里内的所有店铺查询算法, 最好支持 MYSQL.
你这叫审题？  我用集群是不是比你用单机快？

---------------------------------------------------

指定中心点坐标、半径，生成圆面的代码，可以参考我的 AreaCity-Query-Geometry 代码，30 行

https://github.com/xiangyuecn/AreaCity-Query-Geometry/blob/b626c53a85350c43c64e7886e926c3e9ac877a52/AreaCityQuery.java#L1375-L1402

其中采用 Haversine formula 算法 计算经纬度坐标的距离，5 行代码

---------------------------------------------------

没记错的话 redis 好像有这个功能，

---------------------------------------------------

@546L5LiK6ZOt 实际上每经度距离和纬度相关，这样算这个库在北京就用不了了。

---------------------------------------------------

以前流行过 geohash ，如果 MySQL 自己的地理信息功能挑不起来大梁，可以尝试附加一个 geohash

---------------------------------------------------

另外如果可行，还是推荐使用现成可靠的地理信息设施，比如 PostGIS ，应该比 MySQL 自己的 GIS 功能强得多

---------------------------------------------------

不要折腾，全部加载出来，一个工具类的事

---------------------------------------------------

用过 postgis

---------------------------------------------------

楼上一群半吊子，这个是计算量的问题，需要消耗 cpu 资源的，不是换个工具换个数据库就能解决

我司需求是 600 万数据查询经纬度大于 50 米，解决方案是用 spark 并行计算，20 个 task ，一个任务配置 2G 内存

后端大概 50 台刀片机服务器集群，跑一次要 16 个小时

---------------------------------------------------

非要 mysql 吗 geohash 支持那么差劲的
一般用 ES 一步到位或者 Redis 得 geohash 取出 ID 后 mget 获取详情

---------------------------------------------------

@249239432 哈哈 笑死我了才 20w 条记录... 还需要购买额外的资源... 还说别人是半吊子..
说句不客气的话..200w 数据 postgis 也是轻轻松松搞定...
楼上那么多人提到了 geo 相关的服务..你这也不反思下自己... 果然你是最独特的...

希望你的下一条回复是 "经过认真分析,确实 geo 工具有可行性"

---------------------------------------------------

@249239432 我也是搞大数据的，你这个 spark 的方案是真的有问题。spark 也有空间计算库 GeoSpark...。不需要硬算了。不论什么需求，一个 Job16 个小时真的吓到了。 再说了，人家 OP 是要实时查询的方法，很明显用楼上的 redis/mysql geo 数据类型可以解决。

---------------------------------------------------

这个不知道 我司用的是 pg pg 有自带的函数 ST_within 这个函数 能实现你说的功能

---------------------------------------------------

你们就不知道好好审题？，一个心眼钻牛角尖用什么工具、框架、软件上？
集群计算速度快还是用你那台数据库或者 postgis 计算快?

@yingqi1 我用程序硬算都能算出来，纠结这东西干什么，不用集群能变快么？

@changdy 我说的是我司方案，你意淫到别人头上去了？

---------------------------------------------------

@changdy 200w 数据轻松搞定，5 个小时搞定？

---------------------------------------------------

有个很简单很取巧的做法：

经度和纬度分两个字段，并仅对纬度建立索引。由于纬度等距，相差 0.09 度大约为 10 公里，且中国大城市纬度分布差异较大，这样能利用索引初步筛选，把 20 万筛选到 5000 以内。然后再用距离公式精确计算。

---------------------------------------------------

1.mysql 8.x 已经支持了，直接 sql 能实现，加上空间索引搜索非常快

2. redis geo 除了 mysql 之外最快的方案

3. 以上两种方案仅限于单纯的范围检索，如果是社交类的场景比如 5 公里范围内的排序外加+女的+18 的+3 天内上线过的+兴趣爱好 in (a,b,c)  的。那就老老实实上 elasticsearch 类的搜索引擎，没有任何其他方法可以最低成本实现。

---------------------------------------------------

@249239432 典型的数据结构问题，关集群什么事情。  审题: 20 万行数据，产品 ID (int)、经纬度(geohash) 各 8 字节。撑死 10 多 M ，要个鸡毛集群。 再说说 spark 不是框架/软件吗？ 好好学习，请不要再使用“一群半吊子”的词汇了。

---------------------------------------------------

@yingqi1 这是计算量的问题，跟数据大小有什么关系，说不过就开始专牛角尖了？ spark 我还不知道是什么东西么

2. 求最新最快的半径 10 公里内的所有店铺查询算法, 最好支持 MYSQL.
你这叫审题？  我用集群是不是比你用单机快？

---------------------------------------------------

指定中心点坐标、半径，生成圆面的代码，可以参考我的 AreaCity-Query-Geometry 代码，30 行

https://github.com/xiangyuecn/AreaCity-Query-Geometry/blob/b626c53a85350c43c64e7886e926c3e9ac877a52/AreaCityQuery.java#L1375-L1402

其中采用 Haversine formula 算法 计算经纬度坐标的距离，5 行代码

---------------------------------------------------

没记错的话 redis 好像有这个功能，

---------------------------------------------------

@546L5LiK6ZOt 实际上每经度距离和纬度相关，这样算这个库在北京就用不了了。

---------------------------------------------------

以前流行过 geohash ，如果 MySQL 自己的地理信息功能挑不起来大梁，可以尝试附加一个 geohash

---------------------------------------------------

另外如果可行，还是推荐使用现成可靠的地理信息设施，比如 PostGIS ，应该比 MySQL 自己的 GIS 功能强得多

---------------------------------------------------

不要折腾，全部加载出来，一个工具类的事

---------------------------------------------------

用过 postgis

---------------------------------------------------

楼上一群半吊子，这个是计算量的问题，需要消耗 cpu 资源的，不是换个工具换个数据库就能解决

我司需求是 600 万数据查询经纬度大于 50 米，解决方案是用 spark 并行计算，20 个 task ，一个任务配置 2G 内存

后端大概 50 台刀片机服务器集群，跑一次要 16 个小时

---------------------------------------------------

非要 mysql 吗 geohash 支持那么差劲的
一般用 ES 一步到位或者 Redis 得 geohash 取出 ID 后 mget 获取详情

---------------------------------------------------

@249239432 哈哈 笑死我了才 20w 条记录... 还需要购买额外的资源... 还说别人是半吊子..
说句不客气的话..200w 数据 postgis 也是轻轻松松搞定...
楼上那么多人提到了 geo 相关的服务..你这也不反思下自己... 果然你是最独特的...

希望你的下一条回复是 "经过认真分析,确实 geo 工具有可行性"

---------------------------------------------------

@249239432 我也是搞大数据的，你这个 spark 的方案是真的有问题。spark 也有空间计算库 GeoSpark...。不需要硬算了。不论什么需求，一个 Job16 个小时真的吓到了。 再说了，人家 OP 是要实时查询的方法，很明显用楼上的 redis/mysql geo 数据类型可以解决。

---------------------------------------------------

这个不知道 我司用的是 pg pg 有自带的函数 ST_within 这个函数 能实现你说的功能

---------------------------------------------------

你们就不知道好好审题？，一个心眼钻牛角尖用什么工具、框架、软件上？
集群计算速度快还是用你那台数据库或者 postgis 计算快?

@yingqi1 我用程序硬算都能算出来，纠结这东西干什么，不用集群能变快么？

@changdy 我说的是我司方案，你意淫到别人头上去了？

---------------------------------------------------

@changdy 200w 数据轻松搞定，5 个小时搞定？

---------------------------------------------------

有个很简单很取巧的做法：

经度和纬度分两个字段，并仅对纬度建立索引。由于纬度等距，相差 0.09 度大约为 10 公里，且中国大城市纬度分布差异较大，这样能利用索引初步筛选，把 20 万筛选到 5000 以内。然后再用距离公式精确计算。

---------------------------------------------------

1.mysql 8.x 已经支持了，直接 sql 能实现，加上空间索引搜索非常快

2. redis geo 除了 mysql 之外最快的方案

3. 以上两种方案仅限于单纯的范围检索，如果是社交类的场景比如 5 公里范围内的排序外加+女的+18 的+3 天内上线过的+兴趣爱好 in (a,b,c)  的。那就老老实实上 elasticsearch 类的搜索引擎，没有任何其他方法可以最低成本实现。

---------------------------------------------------

@249239432 典型的数据结构问题，关集群什么事情。  审题: 20 万行数据，产品 ID (int)、经纬度(geohash) 各 8 字节。撑死 10 多 M ，要个鸡毛集群。 再说说 spark 不是框架/软件吗？ 好好学习，请不要再使用“一群半吊子”的词汇了。

---------------------------------------------------

@yingqi1 这是计算量的问题，跟数据大小有什么关系，说不过就开始专牛角尖了？ spark 我还不知道是什么东西么

2. 求最新最快的半径 10 公里内的所有店铺查询算法, 最好支持 MYSQL.
你这叫审题？  我用集群是不是比你用单机快？

